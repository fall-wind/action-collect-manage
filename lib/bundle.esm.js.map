{"version":3,"file":"bundle.esm.js","sources":["../src/pubSubManage.ts","../src/index.ts"],"sourcesContent":["import { Subject, Subscription } from 'rxjs';\n\ninterface Listener {\n  fn: (...args: any[]) => void;\n  listen: any;\n}\n\nexport type ActionTypeValue = string;\n\nexport interface EmitArg {\n  value?: any;\n  type: ActionTypeValue;\n  [key: string]: any;\n}\n\nexport interface ItemType {\n  subject: Subject<any>;\n  listeners: Listener[];\n}\n\nexport default class PubSubManage {\n  itemMap: {\n    [key: string]: ItemType;\n  };\n  constructor() {\n    this.itemMap = {};\n  }\n\n  // 为 schedule 返回 subject，做延迟触发\n  on(type: string, fn?: (...args: any[]) => void): Subject<any> {\n    const map = this.itemMap;\n    let item = map[type];\n    let returnSubject = null;\n    if (item) {\n      if (!fn) {\n        return item.subject;\n      }\n      const listen = item.subject.subscribe(fn);\n      item.listeners.push({\n        listen,\n        fn,\n      });\n      returnSubject = item.subject;\n    } else {\n      const subject = new Subject();\n      if (fn) {\n        const listen = subject.subscribe(fn);\n        item = {\n          subject,\n          listeners: [{ fn, listen }],\n        };\n      } else {\n        item = {\n          subject,\n          listeners: [],\n        };\n      }\n      map[type] = item;\n      returnSubject = subject;\n    }\n    return returnSubject;\n  }\n\n  off(type: string, fn?: (...args: any[]) => void) {\n    const item = this.itemMap[type];\n    if (item) {\n      if (!fn) {\n        item.subject.unsubscribe();\n        delete this.itemMap[type];\n      } else {\n        const element = item.listeners.find((ele) => ele.fn === fn);\n        item.listeners = item.listeners.filter((ele) => ele.fn === fn);\n        if (element !== undefined) {\n          element.listen.unsubscribe();\n        }\n      }\n    }\n  }\n\n  emit(type: string, args?: EmitArg) {\n    const item = this.itemMap[type];\n    if (item) {\n      item.subject.next(args);\n    }\n  }\n}\n","import { Subject, merge, VirtualTimeScheduler, Subscription } from 'rxjs';\nimport { observeOn } from 'rxjs/operators';\n\nimport PubSubManage, { EmitArg, ActionTypeValue } from './pubSubManage';\n\nexport class MapItem {\n  cache: EmitArg[];\n  cb: (...args: any[]) => void;\n  scheduler: VirtualTimeScheduler;\n  subject?: Subscription;\n  constructor(cb: (...args: any[]) => void, scheduler: VirtualTimeScheduler) {\n    this.cb = cb;\n    this.scheduler = scheduler;\n    this.cache = [];\n  }\n  receiveValue(value: EmitArg) {\n    this.cache.push(value);\n  }\n\n  perform() {\n    this.scheduler.flush();\n    this.cb(this.cache);\n    this.cache = [];\n  }\n}\n\ninterface InnerMap {\n  [key: string]: MapItem;\n}\n\nexport interface ActionType {\n  type: ActionTypeValue;\n}\n\nexport default class ActionCollectManage {\n  pubSubManage: PubSubManage;\n  map: InnerMap;\n  constructor() {\n    this.pubSubManage = new PubSubManage();\n    this.map = {};\n  }\n\n  registerActive(\n    key: string,\n    actionList: ActionType[],\n    cb: (...args: any[]) => void,\n  ) {\n    if (!actionList.length) {\n      return;\n    }\n    const subjectArr = actionList.reduce((pre, cur) => {\n      const subject = this.pubSubManage.on(cur.type);\n      return [...pre, subject];\n    }, [] as Subject<any>[]);\n    if (this.map[key]) {\n      return;\n    }\n    const scheduler = new VirtualTimeScheduler();\n    const mapItem: MapItem = new MapItem(cb, scheduler);\n    this.map[key] = mapItem;\n    const subject = merge(...subjectArr)\n      .pipe(observeOn(scheduler))\n      .subscribe(mapItem.receiveValue.bind(mapItem));\n    mapItem.subject = subject;\n  }\n\n  emitEvent(params: EmitArg | EmitArg[]) {\n    if (Array.isArray(params)) {\n      params.forEach((param) => {\n        const { type } = param;\n        this.pubSubManage.emit(type, param);\n      });\n    } else {\n      const { type } = params;\n      this.pubSubManage.emit(type, params);\n    }\n  }\n\n  trigger(key: string) {\n    const itemMap = this.map[key];\n    if (itemMap) {\n      itemMap.perform();\n    }\n  }\n\n  cancel(key: string) {\n    const itemMap = this.map[key];\n    if (itemMap) {\n      if (itemMap.subject) {\n        itemMap.subject.unsubscribe();\n        delete this.map[key];\n      }\n    }\n  }\n}\n"],"names":[],"mappings":"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"}